@import db.scalikejdbc.RoundJdbc
@(
        user: org.intracer.wmua.User,
        asUserId: Long,
        asUser: org.intracer.wmua.User,
        files: Seq[org.intracer.wmua.ImageWithRating],
        pager: Pager,
        maybeRound: Option[org.intracer.wmua.Round],
        rounds: Seq[org.intracer.wmua.Round],
        rate: Option[Int] = None,
        region: String = "all",
        byRegion: Map[String, Int],
        rates: RateDistribution)(implicit flash: Flash, lang: Lang, messages: Messages)

    @showRateGalery(file: org.intracer.wmua.ImageWithRating, index: Int) = {
    @defining(maybeRound.get) { round =>

        <div style="margin-bottom: 10px;
            color: #ffffff;"> <b>@file.rankStr</b>
            <span style="margin-left: 5px;
                margin-right: 10px;">
            @if(round.rates.id != 2) {
                @defining(if(round.rates.id <= 5) round.rates.id else round.rates.id / 2) { starsNum =>
                    @for(i <- 1 to starsNum) {
                        <img alt="@i" src="@showStar(i, file.totalRate(round).toInt, round.rates.id <= 10, round.rates.id > 5)">
                    }
                    @file.rateString(round)
                }
            } else {
                @for(i <- 1 to file.totalRate(round).toInt) {
                    <button type="button" class="btn btn-default btn-sm active btn-success">
                        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                    </button>
                }
            }
            </span>
        </div>
    }
    }

    @main("byrate", user, asUserId, asUser, maybeRound, RoundJdbc.activeRounds(user.currentContest.getOrElse(0L)),
        rounds, true, rate, region,
        pagerView(asUserId, pager, rate, maybeRound.flatMap(_.id), region, "byrate"), rates
    ) {

        @defining(maybeRound.get) { round =>
            @defining(round.id.getOrElse(0)) { roundId =>

                    @if(byRegion.nonEmpty) {
                        @regionNav((region: String) => s"/byrate/round/$roundId/user/$asUserId/region/$region/page/1", maybeRound, region, byRegion)
                    }

            <div class="row" >

                <ul class="gallery mw-gallery-traditional">
                @for((file, index) <- files.view.zipWithIndex) {
                    <li class="gallerybox">
                        <h1 id="@file.pageId" style="display: inline;
                            width: 1px;
                            height: 1px"></h1>

                        <div class="thumb">
                            <a href="@routes.Gallery.large(asUserId, file.pageId, region, round.id.get, None, "byrate")" >
                                <img class="cropped" alt="@file.title"
                                src="@controllers.Global.resizeTo(file.image, controllers.Global.gallerySizeX, controllers.Global.gallerySizeY)">
                            </a>
                        </div>

                        @showRateGalery(file, index)

                    </li>
                }

            </ul>
            </div>
            }
        }
    }